import*as fgui from"fairygui-ccc370";import{VertAlignType,AlignType,GObjectPool,GComponent,GLoader,LoaderFillType,GGraph}from"fairygui-ccc370";import{isNull,PoolModule,getEnumName,className,arrayRemoveAll,Shake2DModule,deepClone,notNull,removeNullKeys}from"gnfun";import{UITransform,Widget,Vec2,find,tween,Tween,Color}from"cc";import{SysBase,KitBase}from"coolgame-cc";import TimeSys from"coolgame-cc-sys-time";import{XTween}from"gnfun-cc";let gid=0;class BoneAnim{get lod3d(){return this._lod3d}get skeleton(){return this._lod3d.content}constructor(t,e){this._lod3d=t,this._owner=e,this._ignoreAutoIdle=!1,this._timeSys=e.dlgkit.timeSys,this._onLastAnimComplete=null}config(t){var e;const s=t.vAlign&&"m"!=t.vAlign?"b"==t.vAlign?VertAlignType.Bottom:VertAlignType.Top:VertAlignType.Middle,i=t.align&&"c"!=t.align?"l"==t.align?AlignType.Left:AlignType.Right:AlignType.Center;this._idleAnim=t.idleAnim,this._onLastAnimComplete&&(this._ignoreAutoIdle=!0,this._onLastAnimComplete(),this._ignoreAutoIdle=!1,this._lod3d.animationName=null),this._lod3d.verticalAlign=s,this._lod3d.align=i,this._lod3d.url=this._owner.dlgkit.fuiSys.toUrl(t.model,null!==(e=t.package)&&void 0!==e?e:"Main"),this.playAnim(t.idleAnim,!0)}playAnim(t,e,s,i,o){var l,n;const r=null===(l=null==o?void 0:o.autoIdle)||void 0===l||l,a=this.skeleton;let h=null!==(n=null==o?void 0:o.timeScale)&&void 0!==n?n:1;const d=gid++;this._onLastAnimComplete&&(this._ignoreAutoIdle=!0,this._onLastAnimComplete(),this._ignoreAutoIdle=!1,this._lod3d.animationName=null),this._lod3d.loop=e,this._lod3d.animationName=t,console.log(`[BoneAnim]${d} anim (${t}) play...`),this._timeSys.nextFrame(()=>{if(!this._owner.isClosed&&!e){console.log(`[BoneAnim]${d} anim (${t}) play..`),a.timeScale=h;const e=a.getCurrent(0),o=()=>{console.log(`[BoneAnim]${d} anim (${t}) play over, autoIdle? `+r),this._owner.isClosed||(r&&!this._ignoreAutoIdle&&(this._lod3d.loop=!0,this._lod3d.animationName=this._idleAnim),a.timeScale=1,null==s||s.apply(i))};if(e){let s=-1,i=()=>{isNull(s)||(s=this._timeSys.delete(s),this._onLastAnimComplete=null,o())};s=this._timeSys.delay(e.animation.duration/h,()=>{console.log(`[BoneAnim]${d} anim (${t}) time out`),i()}),this._onLastAnimComplete=i,console.log(`[BoneAnim]${d} anim (${t}) play.`),a.setTrackCompleteListener(e,this._onLastAnimComplete)}else o()}})}}var _a,DlgLayer,DockCompleteDo;class FgoPool{static alloc(t){const e=this._poolOfpool.alloc();return e.reset(t),e}constructor(){this._pool=new GObjectPool}get(){return this._pool.getObject(this._url)}ret(t){this._pool.returnObject(t),t.removeFromParent()}reset(t){this._pool.clear(),this._url=t}}_a=FgoPool,FgoPool._poolOfpool=new PoolModule(()=>new FgoPool,t=>t.reset("")),FgoPool.free=_a._poolOfpool.free.bind(_a._poolOfpool);class FUISys extends SysBase{constructor(){super(...arguments),this.sysName="FUISys"}get timeSys(){return this._timeSys}get fgoPool(){return this._fgoPool}get plat(){return this._getPlat()}get channel(){return this._getChannel()}get root(){return fgui.GRoot.inst}OnInit(t){fgui.GRoot.create(),this.root.node.getComponent(UITransform).setContentSize(1920,1080);const e=this.root.node.addComponent(Widget);e.isAlignHorizontalCenter=!0,e.isAlignVerticalCenter=!0,this._fgoPool=new fgui.GObjectPool,t()}OnLateInit(t){t()}OnDispose(){}init(t,e,s){this._timeSys=t,this._getPlat=e,this._getChannel=s}loadPackage(t,e,s){fgui.UIPackage.loadPackage(t,e,s)}createObject(t,e){return fgui.UIPackage.createObject(t,e)}toUrl(t,e){return fgui.UIPackage.getItemURL(t,e)}toUrlByArr(t){return fgui.UIPackage.getItemURL(t[0],t[1])}allocPool(t){return FgoPool.alloc(t)}freePool(t){FgoPool.free(t)}centerOfGlobal(t){const e=t.pivotAsAnchor?.5-t.pivotX:.5,s=t.pivotAsAnchor?.5-t.pivotY:.5,i=new Vec2(t.width*e,t.height*s);return t.localToGlobal(i.x,i.y)}}!function(t){t[t.Background=0]="Background",t[t.Base=1]="Base",t[t.Front=2]="Front",t[t.Topest=3]="Topest",t[t.GM=4]="GM",t[t.ItemFly=5]="ItemFly",t[t.TopMask=6]="TopMask"}(DlgLayer||(DlgLayer={}));class DlgKit extends KitBase{constructor(){super(...arguments),this.kitName="DlgKit"}get timeSys(){return this._timeSys}get fuiSys(){return this._fuiSys}get plat(){return this._fuiSys.plat}get channle(){return this._fuiSys.channel}OnInit(t){this._fuiSys=this.sys(FUISys),this._timeSys=this.sys(TimeSys),this._layers=new Map,this._dlgList=[],this._getLayer(DlgLayer.Base),t()}OnLateInit(t){t()}OnDispose(){}_getLayer(t){if(this._layers.has(t))return this._layers.get(t);{const e=new GComponent;let s;e.node.name=getEnumName(DlgLayer,t);for(let e=t+1;e<=DlgLayer.TopMask;e++)if(this._layers.has(e)){s=this._layers.get(e);break}return s?this._fuiSys.root.addChildAt(e,this._fuiSys.root.getChildIndex(s)):this._fuiSys.root.addChild(e),this._layers.set(t,e),e}}fetchDlg(t){for(let e=0;e<this._dlgList.length;e++){const s=this._dlgList[e];if(!s.isClosed&&s instanceof t)return s}var e=new t,s=this._fuiSys.createObject(e.dlgPak,e.dlgRes).asCom;return this._getLayer(e.dlgLayer).addChild(s),e.init(s,this),this._dlgList.push(e),console.log("... "+className(e)+"<res:"+e.dlgRes+">"),e}getDlg(t){for(let e=0;e<this._dlgList.length;e++){const s=this._dlgList[e];if(!s.isClosed&&s instanceof t)return s}}closeDlg(t){arrayRemoveAll(this._dlgList,t=>t.isClosed);for(let e=0;e<this._dlgList.length;e++){const s=this._dlgList[e];s instanceof t&&s.close()}}shake(){var t;const e=find("Canvas/Camera"),s=new Vec2(e.position.x,e.position.y),i=new Shake2DModule(3,1,2,"smoothHalfCircle",8,()=>s,t=>{find("Canvas/Camera").setPosition(t.x,t.y)});null===(t=this._shakeTween)||void 0===t||t.stop(),this._shakeTween=tween(i).to(.15,{ratio:1}).start()}}class UIBase{constructor(){this._isClosed=!1,this._fgo=null,this._node=null,this._wrapList=null,this._everOnClickObj=null,this._everEvtListens=null,this._everFgoListens=null,this._everTimers=null,this._everTweenTarget=null,this._dlgkit=null}get dlgkit(){return this._dlgkit}get isClosed(){return this._isClosed}get fgc(){return this._fgo.asCom}get node(){return this._node}init(t,e){null==this._fgo&&(this._fgo=t,this._node=t.node,this._dlgkit=e)}show(){this.isClosed||(this._fgo.visible=!0)}hide(){this.isClosed||(this._fgo.visible=!1)}moveToFront(){this._fgo.parent.setChildIndex(this._fgo,this._fgo.parent.numChildren-1)}close(){var t,e,s,i,o,l;this.isClosed||(null===(t=this._everEvtListens)||void 0===t||t.forEach(([t,e,s,i])=>{null==t||t.off(e,s,i)}),this._everEvtListens=null,null===(e=this._everFgoListens)||void 0===e||e.forEach(([t,e,s,i])=>{t&&!t.isDisposed&&t.off(e,s,i)}),this._everFgoListens=null,null===(s=this._everOnClickObj)||void 0===s||s.forEach(t=>{t&&!t.isDisposed&&t.clearClick()}),this._everOnClickObj=null,null===(i=this._wrapList)||void 0===i||i.forEach(t=>{t.isClosed||t.close()}),this._wrapList=null,null===(o=this._everTimers)||void 0===o||o.forEach(t=>{this._dlgkit.timeSys.delete(t)}),this._everTimers=null,null===(l=this._everTweenTarget)||void 0===l||l.forEach(t=>{Tween.stopAllByTarget(t)}),this._everTweenTarget=null,this.OnDisposeSelfFgo(this._fgo),this._fgo=null,this._node=null,this._isClosed=!0)}wrap(t,e){"string"==typeof e&&(e=this.getChild(e)),this._wrapList||(this._wrapList=[]);var s=new t;return s.init(e,this._dlgkit),this._wrapList.push(s),s}unwrap(t){if(!this._wrapList)return;const e=this._wrapList.indexOf(t);e>-1?(this._wrapList.splice(e,1),t.close(),console.log("unwrap suc "+t)):console.error("this wrap not in list")}getWrap(t){if(!this._wrapList)return null;arrayRemoveAll(this._wrapList,t=>t.isClosed);for(let e=0;e<this._wrapList.length;e++){const s=this._wrapList[e];if(s instanceof t)return s}return null}getWraps(t){return this._wrapList?(arrayRemoveAll(this._wrapList,t=>t.isClosed),this._wrapList.filter(e=>e instanceof t)):[]}getChild(t){return""==t?this.fgc:this.fgc.getChild(t)}getChildInGroup(t,e){return this.fgc.getChildInGroup(t,this.getGroup(e))}ajustPlat(t,e="plat"){const s=this._dlgkit.plat;if(isNull(s))return;const i=this.getChild(t);if(i){const t=i.asCom.getController(e);if(t){let e=0;for(let i=1;i<t.pageCount;i++){if(t.getPageName(i).includes(s)){e=i;break}}t.setSelectedIndex(e)}}}ajustChannel(t,e="channel"){const s=this._dlgkit.channle;if(isNull(s))return;const i=this.getChild(t);if(i){const t=i.asCom.getController(e);if(t){let e=0;for(let i=1;i<t.pageCount;i++){if(t.getPageName(i).includes(s)){e=i;break}}t.setSelectedIndex(e)}}}getCom(t){return this.getChild(t).asCom}getBtn(t){return this.getChild(t).asBtn}getGraph(t){return this.getChild(t).asGraph}getLoader(t){return this.getChild(t).asLoader}getLoader3D(t){return this.getChild(t).asLoader3D}getTxt(t){return this.getChild(t).asTextField}getLabel(t){return this.getChild(t).asLabel}getList(t){return this.getChild(t).asList}getGroup(t){return this.getChild(t).asGroup}getTransition(t){return this.fgc.getTransition(t)}getController(t){return this.fgc.getController(t)}addBtnEvt(t,e,s){null==this._everOnClickObj&&(this._everOnClickObj=new Set),"string"==typeof t&&(t=this.getChild(t));const i=t;i.onClick(()=>{const t=i.grayed;i.enabled=!1,i.grayed=!1,e.call(this,()=>{i.enabled=!0,i.grayed=t})},this),this._everOnClickObj.add(i)}addTween(t){return null==this._everTweenTarget&&(this._everTweenTarget=new Set),this._everTweenTarget.add(t),tween(t)}addXTween(t){return null==this._everTweenTarget&&(this._everTweenTarget=new Set),this._everTweenTarget.add(t),new XTween(t)}addEvt(t,e,s,i){t&&(null==this._everEvtListens&&(this._everEvtListens=[]),null!=i||(i=this),t.on(e,s,i),this._everEvtListens.push([t,e,s,i]))}addFgoEvt(t,e,s,i){t&&(null==this._everFgoListens&&(this._everFgoListens=[]),null!=i||(i=this),t.on(e,s,i),this._everFgoListens.push([t,e,s,i]))}addDelay(t,e,s,...i){return null!=s||(s=this),this._addTimer(t,1,e,s,...i)}addNextFrame(t,e,...s){return null!=e||(e=this),this._addTimer(0,1,t,e,...s)}addInterval(t,e,s,i,...o){return null!=i||(i=this),this._addTimer(t,e,s,i,...o)}delTimer(t){return this._dlgkit.timeSys.delete(t),null}_addTimer(t,e,s,i,...o){if(this._isClosed)return void console.warn("ui is closed cant add timer");const l=this._dlgkit.timeSys.timer(t,e,s,i,...o);return this._everTimers||(this._everTimers=[]),this._everTimers.push(l),l}OnDisposeSelfFgo(t){t.dispose()}}class UIDocker{static create(t,e){let s=UIDocker._pool&&UIDocker._pool.length>0?this._pool.pop():new UIDocker;return s._reset(t,e),s}static destroy(t){t&&(t._destroy(),this._pool||(this._pool=[]),this._pool.push(t))}constructor(){}_reset(t,e){var s,i;this._reversing=void 0,this._target=t,this._outEase=e.out_ease||"quadOut",this._backEase=e.back_ease||"quadIn",this._outDur=null!==(s=e.out_dur)&&void 0!==s?s:.4,this._backDur=null!==(i=e.back_dur)&&void 0!==i?i:.4;let o=this._parseProps(t,e.out),l=this._parseProps(t,e.back),n=o||l;if(o&&l){n=deepClone(n);for(let t in l)n[t]=0}this._outProps=this._getProps(t,n),this._backProps=l,o&&this._setProps(t,o)}dockOut(t){this._internal_dock(!0,t)}dockBack(t){this._internal_dock(!1,t)}_internal_dock(t,e){if(this._takens)for(let e of this._takens)e._internal_dock(t);this._reversing!==!t?(this._clearTween(),this._reversing=!t,t?this._outProps?this._tween=tween(this._target).to(this._outDur,this._outProps,{easing:this._outEase,onComplete:this._handleTweenComplete.bind(this,e)}).start():this._handleTweenComplete(e):this._backProps?this._tween=tween(this._target).to(this._backDur,this._backProps,{easing:this._backEase,onComplete:this._handleTweenComplete.bind(this,e)}).start():this._handleTweenComplete(e)):null==e||e()}take(t){return t?(this._takens||(this._takens=new Array),this._takens.push(t),this):this}_destroy(){if(this._takens){for(let t of this._takens)UIDocker.destroy(t);this._takens=void 0}this._clearTween(),this._target=void 0,this._reversing=void 0,this._outEase=void 0,this._backEase=void 0}_handleTweenComplete(t){this._clearTween(),null==t||t()}_clearTween(){this._tween&&(this._tween.stop(),this._tween=void 0)}_getProps(t,e){if(isNull(e))return;let s={};return this._notNullAndSet(s,e,t,"x"),this._notNullAndSet(s,e,t,"y"),this._notNullAndSet(s,e,t,"alpha"),this._notNullAndSet(s,e,t,"scaleX"),this._notNullAndSet(s,e,t,"scaleY"),s}_setProps(t,e){this._notNullAndSet(t,e,e,"x"),this._notNullAndSet(t,e,e,"y"),this._notNullAndSet(t,e,e,"alpha"),this._notNullAndSet(t,e,e,"scaleX"),this._notNullAndSet(t,e,e,"scaleY")}_notNullAndSet(t,e,s,i){notNull(e[i])&&(t[i]=s[i])}_parseProps(t,e){if(!isNull(e))return removeNullKeys({x:this._dealPropOfMod(t,e,"x"),y:this._dealPropOfMod(t,e,"y"),alpha:this._dealPropOfMod(t,e,"alpha"),scaleX:this._dealPropOfMod(t,e,"scaleX"),scaleY:this._dealPropOfMod(t,e,"scaleY")})}_dealPropOfMod(t,e,s){let i=e[s];const o=e["r"+s],l=e["s"+s];return(o||l)&&(null!=i||(i=0),o&&(i+=t[s]+o),l&&(i+=t["x"==s||"y"==s?"width":s]*l)),i}}UIDocker.Dock={Left:{out:{rx:-120},back:{x:-4,sx:-1},out_ease:"backOut",back_ease:"backIn"},LeftInRightOut:{out:{rx:-120},back:{rx:4,sx:1},out_ease:"backOut",back_ease:"backIn"},Right:{out:{rx:100},back:{rx:4,sx:1},out_ease:"backOut",back_ease:"backIn"},Top:{out:{ry:-120},back:{ry:-3,sy:-1},out_ease:"backOut",back_ease:"backIn"},Bottom:{out:{ry:70},back:{ry:4,sy:1},out_ease:"backOut",back_ease:"backIn"},Fade:{out:{alpha:0},back:{alpha:0},out_ease:"quadOut",back_ease:"quadIn"},FadeSlowly:{out:{alpha:0},back:{alpha:0},out_dur:1.8,back_dur:.6,out_ease:"quadOut",back_ease:"quadIn"},Bubble:{out:{sscaleX:.7,sscaleY:.7,alpha:.2},back:{scaleX:0,scaleY:0,alpha:0},out_ease:"elasticOut",back_ease:"backIn",out_dur:.6,back_dur:.6,pivotX:.5,pivotY:.5},GhostUp:{out:{sscaleX:.9,sscaleY:.9,alpha:.8,ry:10},back:{alpha:0,sscaleX:.9,sscaleY:.9,ry:0},out_ease:"backOut",back_ease:"backIn",out_dur:.3,back_dur:.2,pivotX:.5,pivotY:.5},GhostUp2:{out:{sscaleX:.9,sscaleY:.9,alpha:.8,ry:10},back:{alpha:0,sscaleX:.9,sscaleY:.9,ry:0},out_ease:"backOut",back_ease:"backIn",out_dur:.2,back_dur:0,pivotX:.5,pivotY:.5}},UIDocker.fade_ease="quadOut",function(t){t[t.None=0]="None",t[t.Hide=1]="Hide",t[t.Close=2]="Close"}(DockCompleteDo||(DockCompleteDo={}));class DlgBase extends UIBase{constructor(){super(...arguments),this._bg=null}get dlgPak(){return"Main"}get dlgLayer(){return DlgLayer.Base}get isClosing(){return this._isClosing}init(t,e){super.init(t,e),this._isClosing=!1,this._internal_isShow=!0,this.node.name=this.dlgRes,this._initBlackGraph(),this._initCloseButton(),this._initPlatAjust(),this._initChannelAjust(),this.OnInit()}show(){this._internal_isShow||this.isClosed||this.isClosing||(super.show(),this._bg&&(this._bg.visible=!0),this._dockOut(),this._internal_isShow=!0)}hide(){this._internal_isShow&&(this.isClosed||this.isClosing||(this._dockBack(DockCompleteDo.Hide),this._internal_isShow=!1))}_internal_hide(){super.hide(),this._bg&&(this._bg.visible=!1)}_initCloseButton(){let t=this.getChild(DlgBase.SystemCtrl.CloseButton);t&&t.onClick(this.close,this)}_initPlatAjust(){this.ajustPlat("")}_initChannelAjust(){this.ajustChannel("")}_initBlackGraph(){let t=this.getChild(DlgBase.SystemCtrl.BlackGraph);if(!t){const e=Math.floor(255*this.OnGetBgAlpha());if(e>0){if("loader"==this.OnGetBgType()){let s=new GLoader,i=this.fgc.width,o=this.fgc.height;s.setPosition(-i,-o),s.setSize(3*i,3*o),s.fill=LoaderFillType.ScaleFree,s.color=new Color(0,0,0,e),s.url=this.OnGetBgLoaderResUrl(),s.touchable=!0;let l=this.fgc.parent.getChildIndex(this.fgc);this.fgc.parent.addChildAt(s,l),this.fgc.opaque=!1,t=s}else{let s=new GGraph,i=this.fgc.width,o=this.fgc.height,l=new Color(0,0,0,e);s.setPosition(-i,-o),s.setSize(3*i,3*o),s.drawRect(0,l,l);let n=this.fgc.parent.getChildIndex(this.fgc);this.fgc.parent.addChildAt(s,n),this.fgc.opaque=!1,t=s}}}t&&(t.onClick(()=>{this.OnBgClickClose()&&this.close()},this),this._bg=t)}close(){this.isClosed||this.isClosing?console.warn("dlg alredy closed."):(this._isClosing=!0,this.fgc.touchable=!1,this._dockBack(DockCompleteDo.Close))}dock(t,e){this._docker=UIDocker.destroy(this._docker),t||(t=UIDocker.Dock.Left),e||(e=UIDocker.Dock.Fade);let s=UIDocker.create(this.fgc,t);if(this._bg){const i=deepClone(e);i.out_dur=t.out_dur,i.back_dur=t.back_dur;let o=UIDocker.create(this._bg,i);s.take(o)}t.pivotX&&(this.fgc.pivotX=t.pivotX),t.pivotY&&(this.fgc.pivotY=t.pivotY),this._docker=s,this._dockOut()}moveToFront(){this._bg&&this._bg.parent.setChildIndex(this._bg,this._bg.parent.numChildren-1),super.moveToFront()}_handleDockOver(t,e){t?e===DockCompleteDo.Hide?this._internal_hide():e===DockCompleteDo.Close&&this._internal_close():(this.OnDockOut(),this.fgc.touchable=!0)}_dockOut(){this._docker?this._docker.dockOut(this._handleDockOver.bind(this,!1,DockCompleteDo.None)):this._handleDockOver(!1,DockCompleteDo.None)}_dockBack(t){this._docker?this._docker.dockBack(this._handleDockOver.bind(this,!0,t)):this._handleDockOver(!0,t)}_internal_close(){this.OnClose(),super.close(),this._bg&&(this._bg.dispose(),this._bg=null)}OnClose(){}OnDockOut(){}OnBgClickClose(){return!0}OnGetBgAlpha(){return.7}OnGetBgType(){return"loader"}OnGetBgLoaderResUrl(){return"ui://9fdeszvrl5pz1c"}}DlgBase.SystemCtrl={CloseButton:"sys_closeButton",BlackGraph:"sys_black"};class UIWrap extends UIBase{init(t,e){super.init(t,e),this.OnInit()}close(){this.isClosed?console.error("dlg alredy closed."):(this.OnClose(),super.close())}OnDisposeSelfFgo(t){}OnClose(){}}class ListItem extends UIWrap{getCurData(){return this.curData}refresh(t,e){this.curData=t,this._index=e,this.OnRefresh(this.curData,this._index)}internalRefresh(){this.OnRefresh(this.curData,this._index)}get index(){return this._index}}class ListWrap extends UIWrap{OnInit(){this._list=this.fgc.asList,this._list.setVirtual(),this._list.itemRenderer=this._renderListItem.bind(this)}initList(t,e){this._itemType=t,this._itemDict=new Map,this.SourceData=e}set SourceData(t){this._sourceData=t,this._list.numItems=this._sourceData.length}get SourceData(){return this._sourceData}get itemDict(){return this._itemDict}refreshItemByIndex(t){this._itemDict.forEach(e=>{if(e.index===t)return e.internalRefresh(),!1})}refreshAll(){this._itemDict.forEach(t=>{t.internalRefresh()})}_renderListItem(t,e){let s;this._itemDict.has(e.id)?s=this._itemDict.get(e.id):(s=this.wrap(this._itemType,e),this._itemDict.set(e.id,s)),s.refresh(this._sourceData[t],t)}}export{BoneAnim,DlgBase,DlgKit,FUISys,FgoPool,ListItem,ListWrap,UIBase,UIDocker,UIWrap};